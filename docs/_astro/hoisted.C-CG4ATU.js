const f="$collection-search",p="minisearch-worker.mjs";let n;const a=new Map;let S=100;const g={fuzzy:.3,prefix:!0},d=o=>{if(n)return;if(!o&&typeof document<"u"){let s="/astro-collection-search";s.endsWith("/")||(s+="/"),o=new URL(s,document.baseURI).toString()}const t=[f,p];n=new Worker(new URL(t.join("/"),o||"")),n.onmessage=s=>{if(typeof s.data=="object")switch(s.data.type){case"search-error":{const r=a.get(s.data.transaction);r&&(a.delete(s.data.transaction),r.reject(s.data.message))}break;case"search-results":{const r=a.get(s.data.transaction);r&&(a.delete(s.data.transaction),r.resolve(s.data.list))}break}},n.postMessage({type:"init",base_uri:o})},y=o=>{d(o)},x=(o,t={})=>{d(t.base_uri),t={...g,...t};const s=S++;return new Promise((r,e)=>{if(!n)throw new Error("worker failed");a.set(s,{resolve:r,reject:e}),n.postMessage({type:"search",query:o,options:t,transaction:s})})},L={create_link:o=>{let t="/astro-collection-search";return t.endsWith("/")||(t+="/"),(t+o.collection+"/"+o.file.replace(/\.mdx{0,1}$/,"")).toLowerCase()},group_header:o=>`Results from ${o}:`,no_results_text:"Your search returned no results"},_=()=>{c||m(),c?.Open()},m=(o={})=>{if(!c){const t=document.querySelector("#overlay-search-dialog");if(t instanceof HTMLDialogElement)c=new v(t,{...L,...o});else throw"overlay search: dialog element not found"}};class v{constructor(t,s){this.dialog=t,this.options=s,this.selected_index=-1,document.body.append(t),this.input=t.querySelector(".query"),this.results=t.querySelector(".search-results"),this.template=t.querySelector(".result-template"),this.clear_button=t.querySelector(".clear-query"),this.group_template=t.querySelector(".result-group-header-template"),t.addEventListener("mousedown",e=>{e.target===t&&t.close()}),this.results.addEventListener("focusin",e=>{e.target instanceof HTMLElement&&e.target.classList.contains("search-result")&&this.SelectElement(e.target)}),this.results.addEventListener("mousemove",e=>{e.target instanceof HTMLElement&&e.target.classList.contains("search-result")&&this.SelectElement(e.target)}),this.results.addEventListener("click",e=>{e.target instanceof HTMLElement&&e.target.dataset.link&&(document.location=e.target.dataset.link)});let r=0;this.results.addEventListener("scroll",e=>{r||(r=window.setTimeout(()=>{sessionStorage.setItem("scroll-top",this.results.scrollTop.toString()),r=0},250))}),this.input.addEventListener("input",async()=>{const e=this.input.value.trim();if(e){const i=await x(e);this.PopulateResults(i),this.results.scrollTop=0,this.StoreSessionData(e,"",i)}else this.results.textContent="",this.SetResultsState("no-query"),this.StoreSessionData()}),this.clear_button.addEventListener("click",()=>{this.input.value="",this.results.textContent="",this.StoreSessionData()}),this.Init()}StoreSessionData(t="",s="",r=[]){sessionStorage.setItem("query",t),sessionStorage.setItem("selected-index",s.toString()),sessionStorage.setItem("results",JSON.stringify(r))}SetResultsState(t){switch(t){case"no-query":this.results.classList.remove("no-results"),this.results.classList.remove("results"),this.results.classList.add("no-query");break;case"no-results":this.results.classList.add("no-results"),this.results.classList.remove("results"),this.results.classList.remove("no-query");break;case"results":this.results.classList.remove("no-results"),this.results.classList.add("results"),this.results.classList.remove("no-query");break}}SelectElement(t){this.active_node!==t&&(this.active_node&&this.active_node.classList.remove("active"),this.active_node=t,this.active_node.classList.add("active"),this.selected_index=Number(this.active_node.dataset.index),sessionStorage.setItem("selected-index",this.selected_index.toString()))}SetContent(t,s){for(const[r,e]of Object.entries(s)){const i=t.querySelector(`[data-target=${r}]`);if(i)if(typeof e=="string")i.textContent=e;else{typeof e.text=="string"&&(i.textContent=e.text);for(const l of Object.entries(e.attributes))i.setAttribute(...l)}}return t}PopulateResults(t){if(this.options.threshold){const s=this.options.threshold;t=t.filter(r=>r.score>=s)}if(this.options.max&&(t=t.slice(0,this.options.max)),!t.length)this.results.textContent=this.options.no_results_text,this.SetResultsState("no-results");else{this.results.textContent="",this.SetResultsState("results");const s={};for(const e of t){const i=e.collection;s[i]||(s[i]=[]),s[i].push(e)}let r=0;for(const[e,i]of Object.entries(s)){const l=this.group_template.content.cloneNode(!0);this.SetContent(l,{"result-group-header":this.options.group_header(e)}),this.results.append(l),this.results.append(...i.map(u=>{const h=this.template.content.cloneNode(!0);return this.SetContent(h,{title:u.frontmatter.title||"No title",description:u.frontmatter.description||"No description",result:{attributes:{"data-link":this.options.create_link(u),"data-index":(r++).toString()}}}),h}))}}}Open(){y(),this.dialog.showModal();const t=sessionStorage.getItem("scroll-top");t&&requestAnimationFrame(()=>{this.results.scrollTop=Number(t)})}Init(){const t=sessionStorage.getItem("query")||"";this.input.value=t,this.SetResultsState("no-query");const s=sessionStorage.getItem("results");if(s&&t)try{const e=JSON.parse(s);Array.isArray(e)&&this.PopulateResults(e)}catch(e){console.error(e)}let r=sessionStorage.getItem("selected-index");if(r){this.selected_index=Number(r);const e=this.dialog.querySelector(`[data-index="${this.selected_index}"]`);e instanceof HTMLElement&&(this.active_node=e,this.active_node.classList.add("active"))}}}let c;m({max:12});document.querySelector(".open-search-dialog")?.addEventListener("click",()=>_());export{x as S,y as W};
